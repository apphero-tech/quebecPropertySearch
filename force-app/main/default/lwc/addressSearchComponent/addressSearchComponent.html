<template>
    <lightning-card title="Recherche de Propri√©t√©s" icon-name="standard:address">
        <div class="slds-p-around_medium">
            
            <!-- S√©lection de municipalit√© -->
            <div class="slds-form-element slds-m-bottom_medium">
                <label class="slds-form-element__label" for="municipality-select">
                    <abbr class="slds-required" title="required">*</abbr>
                    Municipalit√©
                </label>
                <div class="slds-form-element__control">
                    <lightning-combobox
                        id="municipality-select"
                        name="municipality"
                        label=""
                        value={selectedMunicipality}
                        placeholder="S√©lectionner une municipalit√©"
                        options={municipalityOptions}
                        onchange={handleMunicipalityChange}
                        disabled={isLoadingMunicipalities}>
                    </lightning-combobox>
                    
                    <!-- Indicateur de chargement -->
                    <template if:true={isLoadingMunicipalities}>
                        <lightning-spinner alternative-text="Chargement des municipalit√©s..." size="small"></lightning-spinner>
                    </template>
                </div>
            </div>
            
            <!-- Recherche de rue -->
            <div class="slds-form-element slds-m-bottom_medium">
                <label class="slds-form-element__label" for="street-input">
                    <abbr class="slds-required" title="required">*</abbr>
                    Voie publique
                </label>
                <div class="slds-form-element__control">
                    <div class="slds-input-has-icon slds-input-has-icon_right">
                        <lightning-input
                            id="street-input"
                            type="text"
                            label=""
                            placeholder="Tapez le nom de la rue (ex: SAINT)"
                            value={streetInput}
                            onchange={handleStreetInput}
                            class={streetInputClass}
                            disabled={isLoadingStreets}>
                        </lightning-input>
                        
                        <!-- Indicateur de chargement -->
                        <template if:true={isLoadingStreets}>
                            <lightning-spinner alternative-text="Recherche en cours..." size="small"></lightning-spinner>
                        </template>
                    </div>
                </div>
            </div>
            
            <!-- Suggestions de rues -->
            <template if:true={showStreetSuggestions}>
                <div class={streetSuggestionsClass}>
                    <ul class="slds-dropdown slds-dropdown_length-with-icon-7 slds-dropdown_fluid">
                        <template for:each={streetSuggestions} for:item="street">
                            <li key={street} class="slds-dropdown__item">
                                <a 
                                    class="slds-dropdown__item-action slds-truncate" 
                                    data-value={street}
                                    onclick={handleStreetSelection}
                                    title={street}>
                                    <lightning-icon 
                                        icon-name="standard:address" 
                                        size="x-small" 
                                        class="slds-m-right_x-small">
                                    </lightning-icon>
                                    {street}
                                </a>
                            </li>
                        </template>
                    </ul>
                </div>
            </template>
            
            <!-- Recherche de num√©ro -->
            <div class="slds-form-element slds-m-bottom_medium">
                <label class="slds-form-element__label" for="number-input">
                    <abbr class="slds-required" title="required">*</abbr>
                    Num√©ro civique
                </label>
                <div class="slds-form-element__control">
                    <lightning-input
                        id="number-input"
                        type="text"
                        label=""
                        placeholder="Saisissez le num√©ro civique"
                        value={numberInput}
                        onchange={handleNumberInput}
                        class={numberInputClass}
                        disabled={isNumberDisabled}>
                    </lightning-input>
                </div>
            </div>
            
            <!-- Bouton de recherche -->
            <div class="slds-form-element slds-m-bottom_medium">
                <lightning-button
                    label="Rechercher"
                    onclick={handleSearch}
                    disabled={searchDisabled}
                    variant="brand"
                    class="slds-m-top_small">
                </lightning-button>
            </div>
            
            <!-- Rue s√©lectionn√©e -->
            <template if:true={selectedStreet}>
                <div class="slds-m-top_small">
                    <lightning-badge label="Rue s√©lectionn√©e" variant="success"></lightning-badge>
                    <span class="slds-m-left_small">{selectedStreet}</span>
                </div>
            </template>
            
            <!-- Zone de r√©sultats -->
            <div class="slds-m-top_medium">
                
                <!-- Loading -->
                <template if:true={isLoadingProperty}>
                    <div class="slds-text-align_center">
                        <lightning-spinner size="small" alternative-text="Recherche de propri√©t√© en cours..."></lightning-spinner>
                        <p>Recherche en cours...</p>
                    </div>
                </template>
                
                <!-- Propri√©t√© trouv√©e -->
                <template if:true={showPropertyDetails}>
                    <div class="slds-box slds-theme_default">
                        <h3 class="slds-text-heading_small slds-m-bottom_small">
                            üè† {propertyAddress}
                        </h3>
                        
                        <!-- Accord√©ons pour les sections du r√¥le d'√©valuation -->
                        <lightning-accordion allow-multiple-sections-open class="property-details-accordion">
                            
                            <!-- En-t√™te du r√¥le -->
                            <lightning-accordion-section name="header" label="üìã En-t√™te du r√¥le">
                                <div class="slds-grid slds-wrap slds-gutters">
                                    <div class="slds-col slds-size_1-of-2">
                                        <p><strong>Code g√©ographique :</strong> {propertyDetails.RLM01A}</p>
                                        <p><strong>Mill√©sime :</strong> {propertyDetails.RLM02A}</p>
                                    </div>
                                    <div class="slds-col slds-size_1-of-2">
                                        <p><strong>Version :</strong> {propertyDetails.VERSION}</p>
                                    </div>
                                </div>
                            </lightning-accordion-section>
                            
                            <!-- Section 1 : Identification de l'unit√© d'√©valuation -->
                            <lightning-accordion-section name="identification" label="üìç Section 1 : Identification de l'unit√© d'√©valuation">
                                <div class="slds-grid slds-wrap slds-gutters">
                                    <div class="slds-col slds-size_1-of-2">
                                        <p><strong>Adresse :</strong> {fullAddress}</p>
                                        <p><strong>Code postal :</strong> {formattedPostalCode}</p>
                                        <p><strong>Matricule :</strong> {matricule}</p>
                                    </div>
                                    <div class="slds-col slds-size_1-of-2">
                                        <p><strong>Num√©ro de lot :</strong> {lotNumber}</p>
                                        <p><strong>Num√©ro d'ordre :</strong> {orderNumber}</p>
                                        <p><strong>Num√©ro de dossier :</strong> {fileNumber}</p>
                                        <p><strong>Num√©ro de cadastre :</strong> {cadastreNumber}</p>
                                    </div>
                                </div>
                            </lightning-accordion-section>
                            
                            <!-- Section 2 : Identification du propri√©taire -->
                            <lightning-accordion-section name="owner" label="üë§ Section 2 : Identification du propri√©taire">
                                <div class="slds-grid slds-wrap slds-gutters">
                                    <div class="slds-col slds-size_1-of-1">
                                        <p><strong>Nom du propri√©taire :</strong> {ownerName}</p>
                                        <p if:true={ownerFirstName}><strong>Pr√©nom du propri√©taire :</strong> {ownerFirstName}</p>
                                        <p><strong>Type de propri√©taire :</strong> {ownerType}</p>
                                        <p><strong>Adresse du propri√©taire :</strong> {ownerFullAddress}</p>
                                        <p><strong>Date d'acquisition :</strong> {acquisitionDate}</p>
                                        <p><strong>Nombre de propri√©taires :</strong> {ownerCount}</p>
                                    </div>
                                </div>
                            </lightning-accordion-section>
                            
                            <!-- Section 3 : Caract√©ristiques du terrain -->
                            <lightning-accordion-section name="land" label="üåç Section 3 : Caract√©ristiques du terrain">
                                <div class="slds-grid slds-wrap slds-gutters">
                                    <div class="slds-col slds-size_1-of-3">
                                        <p><strong>Mesure frontale :</strong> {frontage}</p>
                                    </div>
                                    <div class="slds-col slds-size_1-of-3">
                                        <p><strong>Superficie :</strong> {area}</p>
                                    </div>
                                    <div class="slds-col slds-size_1-of-3">
                                        <p><strong>Facteur d'ajustement :</strong> {adjustmentFactor}</p>
                                    </div>
                                </div>
                            </lightning-accordion-section>
                            
                            <!-- Section 4 : Valeurs port√©es au r√¥le -->
                            <lightning-accordion-section name="values" label="üí∞ Section 4 : Valeurs port√©es au r√¥le">
                                <div class="slds-grid slds-wrap slds-gutters">
                                    <div class="slds-col slds-size_1-of-2">
                                        <p><strong>Date de r√©f√©rence :</strong> {referenceDate}</p>
                                        <p><strong>Valeur du terrain :</strong> {landValue}</p>
                                        <p><strong>Valeur du b√¢timent :</strong> {buildingValue}</p>
                                    </div>
                                    <div class="slds-col slds-size_1-of-2">
                                        <p><strong>Valeur de l'immeuble :</strong> {propertyValue}</p>
                                        <p><strong>Valeur imposable :</strong> {taxableValue}</p>
                                    </div>
                                </div>
                            </lightning-accordion-section>
                            
                            <!-- Section 5 : Exon√©rations -->
                            <lightning-accordion-section name="exemptions" label="üèõÔ∏è Section 5 : Exon√©rations">
                                <div class="slds-grid slds-wrap slds-gutters">
                                    <div class="slds-col slds-size_1-of-1">
                                        <p><strong>Valeur exon√©r√©e :</strong> {exemptValue}</p>
                                        <template if:true={exemptionDetails.length}>
                                            <p><strong>D√©tails des exon√©rations :</strong></p>
                                            <template for:each={exemptionDetails} for:item="exemption">
                                                <div key={exemption.code} class="slds-box slds-m-top_x-small exemption-details">
                                                    <p><strong>Code :</strong> {exemption.code}</p>
                                                    <p><strong>Valeur :</strong> {exemption.value}</p>
                                                    <p><strong>Type :</strong> {exemption.type}</p>
                                                    <p if:true={exemption.description}><strong>Description :</strong> {exemption.description}</p>
                                                </div>
                                            </template>
                                        </template>
                                    </div>
                                </div>
                            </lightning-accordion-section>
                            
                            <!-- Section 6 : D√©claration de d√©p√¥t du r√¥le par l'√©valuateur -->
                            <lightning-accordion-section name="evaluator" label="üìù Section 6 : D√©claration de d√©p√¥t du r√¥le par l'√©valuateur">
                                <div class="slds-grid slds-wrap slds-gutters">
                                    <div class="slds-col slds-size_1-of-2">
                                        <p><strong>Nom de l'√©valuateur :</strong> {evaluatorName}</p>
                                        <p><strong>Pr√©nom de l'√©valuateur :</strong> {evaluatorFirstName}</p>
                                        <p><strong>Titre :</strong> {evaluatorTitle}</p>
                                    </div>
                                    <div class="slds-col slds-size_1-of-2">
                                        <p><strong>Organisme municipal :</strong> {evaluatorOrganization}</p>
                                        <p><strong>Date de signature :</strong> {signatureDate}</p>
                                        <p><strong>Lieu de signature :</strong> {signatureLocation}</p>
                                    </div>
                                </div>
                            </lightning-accordion-section>
                            
                            <!-- Informations annexables globales -->
                            <lightning-accordion-section name="global" label="üìä Informations annexables globales">
                                <div class="slds-grid slds-wrap slds-gutters">
                                    <div class="slds-col slds-size_1-of-2">
                                        <p><strong>Version des informations :</strong> {globalInfoVersion}</p>
                                    </div>
                                    <div class="slds-col slds-size_1-of-2">
                                        <p><strong>Date de mise √† jour :</strong> {globalInfoDate}</p>
                                    </div>
                                </div>
                            </lightning-accordion-section>
                            
                            <!-- Informations annexables unit√© -->
                            <lightning-accordion-section name="unit" label="üè¢ Informations annexables unit√©">
                                <div class="slds-grid slds-wrap slds-gutters">
                                    <div class="slds-col slds-size_1-of-2">
                                        <p><strong>Nombre d'unit√©s :</strong> {unitCount}</p>
                                        <p><strong>Superficie unitaire :</strong> {unitArea}</p>
                                        <p><strong>Valeur unitaire :</strong> {unitValue}</p>
                                        <p><strong>Valeur fonci√®re unitaire :</strong> {landUnitValue}</p>
                                    </div>
                                    <div class="slds-col slds-size_1-of-2">
                                        <p><strong>Type de propri√©t√© :</strong> {propertyType}</p>
                                        <p><strong>Cat√©gorie :</strong> {propertyCategory}</p>
                                        <p><strong>Date d'√©valuation :</strong> {evaluationDate}</p>
                                        <p><strong>Valeur b√¢timent unitaire :</strong> {buildingUnitValue}</p>
                                    </div>
                                </div>
                            </lightning-accordion-section>
                            
                        </lightning-accordion>
                    </div>
                </template>
                
                <!-- Aucun r√©sultat -->
                <template if:true={showNoResults}>
                    <div class="slds-box slds-theme_warning">
                        <h3 class="slds-text-heading_small">
                            ‚ùå Aucun r√©sultat
                        </h3>
                        <p>{noResultsMessage}</p>
                    </div>
                </template>
                
            </div>
            

            
        </div>
    </lightning-card>
</template> 