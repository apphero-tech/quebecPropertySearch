<template>
    <lightning-card title="Recherche de Propriétés Québec" icon-name="standard:address">
        <div class="slds-p-around_medium">
            
            <!-- Types de recherche -->
            <div class="slds-m-bottom_medium">
                <lightning-button-group>
                    <lightning-button 
                        label="Par Adresse" 
                        value="address" 
                        variant={addressButtonVariant}
                        onclick={handleSearchTypeChange}>
                    </lightning-button>
                    <lightning-button 
                        label="Par Propriétaire" 
                        value="owner" 
                        variant={ownerButtonVariant}
                        onclick={handleSearchTypeChange}>
                    </lightning-button>
                    <lightning-button 
                        label="Par Matricule" 
                        value="matricule" 
                        variant={matriculeButtonVariant}
                        onclick={handleSearchTypeChange}>
                    </lightning-button>
                    <lightning-button 
                        label="Par Lot" 
                        value="lot" 
                        variant={lotButtonVariant}
                        onclick={handleSearchTypeChange}>
                    </lightning-button>
                </lightning-button-group>
            </div>
            
            <!-- Formulaire de recherche par adresse -->
            <template if:true={isAddressSearch}>
                <div class="slds-form">
                    
                    <!-- Municipalité -->
                    <div class="slds-form-element slds-m-bottom_medium">
                        <label class="slds-form-element__label" for="municipality-select">
                            <abbr class="slds-required" title="required">*</abbr>
                            Municipalité
                        </label>
                        <div class="slds-form-element__control">
                            <lightning-combobox
                                id="municipality-select"
                                name="municipality"
                                label=""
                                value={selectedMunicipality}
                                placeholder="Sélectionner une municipalité"
                                options={municipalityOptions}
                                onchange={handleMunicipalityChange}
                                disabled={isLoadingMunicipalities}>
                            </lightning-combobox>
                            
                            <template if:true={isLoadingMunicipalities}>
                                <lightning-spinner alternative-text="Chargement des municipalités..." size="small"></lightning-spinner>
                            </template>
                        </div>
                    </div>
                    
                    <!-- Rue avec autocomplétion - ALIGNEMENT CORRIGÉ -->
                    <div class="slds-form-element slds-m-bottom_medium">
                        <label class="slds-form-element__label" for="street-input">
                            <abbr class="slds-required" title="required">*</abbr>
                            Voie publique
                        </label>
                        <div class="slds-form-element__control">
                            <!-- Container avec position relative pour l'alignement -->
                            <div class="street-input-container">
                                <lightning-input
                                    id="street-input"
                                    type="text"
                                    label=""
                                    placeholder="Commencez à taper le nom de la rue..."
                                    value={streetInput}
                                    onchange={handleStreetInput}
                                    onfocus={handleStreetFocus}
                                    class="slds-m-bottom_small">
                                </lightning-input>
                                
                                <!-- Suggestions de rues - ALIGNEMENT PARFAIT -->
                                <template if:true={showStreetSuggestions}>
                                    <div class="street-suggestions">
                                        <template for:each={streetOptions} for:item="street">
                                            <div key={street.value} 
                                                 class="street-option"
                                                 data-value={street.value}
                                                 onclick={handleStreetSelection}>
                                                <lightning-icon 
                                                    icon-name="standard:address" 
                                                    size="x-small" 
                                                    class="slds-m-right_x-small">
                                                </lightning-icon>
                                                {street.label}
                                            </div>
                                        </template>
                                    </div>
                                </template>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Numéro civique -->
                    <div class="slds-form-element slds-m-bottom_medium">
                        <label class="slds-form-element__label" for="number-input">
                            <abbr class="slds-required" title="required">*</abbr>
                            Numéro civique
                        </label>
                        <div class="slds-form-element__control">
                            <lightning-input
                                id="number-input"
                                type="text"
                                label=""
                                placeholder="Saisissez le numéro civique"
                                value={numberInput}
                                onchange={handleNumberInput}
                                disabled={isNumberDisabled}>
                            </lightning-input>
                        </div>
                    </div>
                    
                </div>
            </template>
            
            <!-- Formulaire de recherche par propriétaire -->
            <template if:true={isOwnerSearch}>
                <div class="slds-form">
                    <!-- Municipalité (affichage en lecture seule pour cohérence) -->
                    <div class="slds-form-element slds-m-bottom_small">
                        <label class="slds-form-element__label">Municipalité</label>
                        <div class="slds-form-element__control">
                            <lightning-input
                                type="text"
                                value={selectedMunicipality}
                                disabled
                                class="disabled-input">
                            </lightning-input>
                        </div>
                    </div>

                    <!-- Champ Nom avec suggestions - structure IDENTIQUE au champ Rue -->
                    <div class="slds-form-element slds-m-bottom_medium">
                        <label class="slds-form-element__label" for="owner-input">
                            <abbr class="slds-required" title="required">*</abbr>
                            Nom
                        </label>
                        <div class="slds-form-element__control">
                            <div class="street-input-container">
                                <lightning-input
                                    id="owner-input"
                                    type="text"
                                    label=""
                                    placeholder="Taper ou coller le nom complet du propriétaire recherché"
                                    value={ownerForm.name}
                                    onchange={handleOwnerNameChange}
                                    onfocus={handleOwnerFocus}
                                    onblur={handleOwnerBlur}
                                    class="slds-m-bottom_small">
                                </lightning-input>

                                <template if:true={showOwnerSuggestions}>
                                    <div class="street-suggestions" onmouseenter={handleOwnerDropdownMouseEnter} onmouseleave={handleOwnerDropdownMouseLeave}>
                                        <template for:each={ownerSuggestions} for:item="sugg">
                                            <div key={sugg.id}
                                                 class="street-option"
                                                 data-ownername={sugg.value}
                                                 data-ownerdisplay={sugg.display}
                                                 onclick={handleOwnerSelection}>
                                                <lightning-icon icon-name="standard:people" size="x-small" class="slds-m-right_x-small"></lightning-icon>
                                                {sugg.display}
                                            </div>
                                        </template>
                                    </div>
                                </template>
                            </div>
                        </div>
                        <div class="slds-form-element__help slds-text-color_weak">
                            Exemples : "BRIEN, RITA" ou "VILLE DE KIRKLAND"
                        </div>
                    </div>

                    <!-- Plus de champ Prénom: simplification -->

                    <!-- Message personne morale détectée -->
                    <template if:true={isCompanyDetected}>
                        <div class="slds-notify slds-notify_alert slds-theme_info slds-m-bottom_small">
                            <span class="slds-assistive-text">Info</span>
                            <h2>Personne morale détectée - recherche directe</h2>
                        </div>
                    </template>
                </div>
            </template>
            
            <!-- Formulaire de recherche par matricule -->
            <template if:true={isMatriculeSearch}>
                <div class="slds-form">
                    <div class="slds-form-element slds-m-bottom_medium">
                        <label class="slds-form-element__label" for="matricule-input">
                            <abbr class="slds-required" title="required">*</abbr>
                            Numéro de matricule
                        </label>
                        <div class="slds-form-element__control">
                            <lightning-input
                                id="matricule-input"
                                type="text"
                                label=""
                                placeholder="Entrez le numéro de matricule"
                                value={matriculeInput}
                                onchange={handleMatriculeInput}>
                            </lightning-input>
                        </div>
                    </div>
                </div>
            </template>
            
            <!-- Formulaire de recherche par lot -->
            <template if:true={isLotSearch}>
                <div class="slds-form">
                    <div class="slds-form-element slds-m-bottom_medium">
                        <label class="slds-form-element__label" for="lot-input">
                            <abbr class="slds-required" title="required">*</abbr>
                            Numéro de lot
                        </label>
                        <div class="slds-form-element__control">
                            <lightning-input
                                id="lot-input"
                                type="text"
                                label=""
                                placeholder="Entrez le numéro de lot"
                                value={lotInput}
                                onchange={handleLotInput}>
                            </lightning-input>
                        </div>
                    </div>
                </div>
            </template>
            
            <!-- Bouton de recherche -->
            <div class="slds-form-element slds-m-bottom_medium">
                <lightning-button
                    label="Rechercher"
                    onclick={handleSearch}
                    disabled={searchDisabled}
                    variant="brand"
                    class="slds-m-top_small">
                </lightning-button>
            </div>
            
            <!-- Rue sélectionnée -->
            <template if:true={selectedStreet}>
                <div class="slds-m-top_small">
                    <lightning-badge label="Rue sélectionnée" variant="success"></lightning-badge>
                    <span class="slds-m-left_small">{displaySelectedStreet}</span>
                </div>
            </template>
            
            <!-- Zone de résultats -->
            <div class="slds-m-top_medium">
                
                <!-- Loading -->
                <template if:true={isLoadingProperty}>
                    <div class="slds-text-align_center">
                        <lightning-spinner size="small" alternative-text="Recherche de propriété en cours..."></lightning-spinner>
                        <p>Recherche en cours...</p>
                    </div>
                </template>
                
                <!-- Propriétés trouvées -->
                <template if:true={showPropertyDetails}>
                    <template for:each={properties} for:item="property" for:index="index">
                        <div key={property.id} class="slds-m-bottom_large">
                            
                            <!-- CARD POUR CHAQUE PROPRIÉTÉ -->
                            <lightning-card icon-name="standard:address">
                                <div slot="title">
                                    <div class="property-header">
                                        <h2 class="property-address slds-text-heading_medium">{property.formattedPropertyAddress}</h2>
                                    </div>
                                </div>
                                
                                <!-- ACCORDÉON AVEC TOUTES LES SECTIONS -->
                                <lightning-accordion allow-multiple-sections-open class="property-details-accordion">
                                    
                                    <!-- SECTION 1 : Identification de l'unité d'évaluation -->
                                    <lightning-accordion-section name="section1" label="📍 Section 1 : Identification de l'unité d'évaluation">
                                        <div class="slds-p-around_medium">
                                            <!-- Dossier et classification -->
                                            <div class="slds-box slds-m-bottom_medium">
                                                <h4 class="slds-text-heading_small slds-m-bottom_small">Dossier et classification</h4>
                                                <template if:true={property.displayNumeroDossier}>
                                                    <p><strong>Numéro de dossier :</strong> <span data-field="matricule">{property.displayNumeroDossier}</span></p>
                                                                    </template>
                                                <template if:true={property.displayUtilisation}>
                                                    <p><strong>Utilisation :</strong> {property.displayUtilisation}</p>
                                                                        </template>
                                                <template if:true={property.displayUniteVoisinage}>
                                                    <p><strong>Unité de voisinage :</strong> {property.displayUniteVoisinage}</p>
                                                                            </template>
                                            </div>
                                            
                                            <!-- Informations du rôle -->
                                            <div class="slds-box slds-m-bottom_medium">
                                                <h4 class="slds-text-heading_small slds-m-bottom_small">Informations du rôle</h4>
                                                <template if:true={property.displayVersion}>
                                                    <p><strong>Version :</strong> {property.displayVersion}</p>
                                                                    </template>
                                                <template if:true={property.displayCodeMunicipalite}>
                                                    <p><strong>Code municipalité :</strong> {property.displayCodeMunicipalite}</p>
                                                                    </template>
                                                <template if:true={property.displayAnneeRole}>
                                                    <p><strong>Année du rôle :</strong> {property.displayAnneeRole}</p>
                                                            </template>
                                            </div>
                                            
                                            <!-- Identification cadastrale -->
                                            <div class="slds-box slds-m-bottom_medium">
                                                <h4 class="slds-text-heading_small slds-m-bottom_small">Identification cadastrale</h4>
                                                <template if:true={property.displayRl0104A}>
                                                    <p><strong>Division :</strong> {property.displayRl0104A}</p>
                                                                        </template>
                                                <template if:true={property.displayRl0104B}>
                                                    <p><strong>Section :</strong> {property.displayRl0104B}</p>
                                                                            </template>
                                                <template if:true={property.displayRl0104C}>
                                                    <p><strong>Emplacement :</strong> {property.displayRl0104C}</p>
                                                                                </template>
                                                <template if:true={property.displayRl0104G}>
                                                    <p><strong>Numéro du fuseau :</strong> {property.displayRl0104G}</p>
                                                                                </template>
                                                <template if:true={property.displayRl0104D}>
                                                    <p><strong>Chiffre autovérificateur :</strong> {property.displayRl0104D}</p>
                                                                        </template>
                                                    </div>
                                        </div>
                                    </lightning-accordion-section>
                                    
                                    <!-- SECTION 2 : Identification du propriétaire -->
                                    <lightning-accordion-section name="section2" label="👤 Section 2 : Identification du propriétaire">
                                        <div class="slds-p-around_medium">
                                            <!-- Un encart par propriétaire, empilés -->
                                            <template for:each={property.formattedOwners} for:item="owner">
                                                <div key={owner.id} class="slds-box slds-m-bottom_medium">
                                                    <p class="slds-text-title_bold slds-m-bottom_x-small">{owner.formattedName}</p>
                                                    <template if:true={owner.ownerTypeText}>
                                                        <p class="slds-text-body_small slds-text-color_weak slds-m-bottom_x-small">{owner.ownerTypeText}</p>
                                                                    </template>
                                                    <template if:true={owner.fullAddress}>
                                                        <p class="slds-text-body_small slds-m-bottom_x-small">{owner.fullAddress}</p>
                                                                        </template>
                                                    <template if:true={owner.registrationDate}>
                                                        <p class="slds-text-body_small slds-text-color_weak">Inscrit: {owner.registrationDate}</p>
                                                                    </template>
                                                                </div>
                                                            </template>
                                        </div>
                                    </lightning-accordion-section>
                                    
                                    <!-- SECTION 3 : Caractéristiques de l'unité d'évaluation -->
                                    <lightning-accordion-section if:true={property.section3Visible} name="section3" label="🌍 Section 3 : Caractéristiques de l'unité d'évaluation">
                                        <div class="slds-p-around_medium">
                                            <!-- Bâtiment principal -->
                                            <div class="slds-box slds-m-bottom_medium">
                                                <h4 class="slds-text-heading_small slds-m-bottom_small">Bâtiment principal</h4>
                                                <div class="slds-grid slds-wrap slds-gutters">
                                                    <div class="slds-col slds-size_1-of-2 slds-max-small-size_1-of-1">
                                                        <template if:true={property.displayRl0306A}>
                                                            <p><strong>Nombre d'étages :</strong> {property.displayRl0306A}</p>
                                                        </template>
                                                        <template if:true={property.displayRl0307A}>
                                                            <p><strong>Année de construction :</strong> {property.displayRl0307A}</p>
                                                        </template>
                                                        <template if:true={property.displayRl0307B}>
                                                            <p><strong>Type de construction :</strong> {property.displayRl0307B}</p>
                                                        </template>
                                                        <template if:true={property.displayRl0317A}>
                                                            <p><strong>Superficie bâtiment :</strong> {property.displayRl0317A}</p>
                                                        </template>
                                                    </div>
                                                </div>
                                                                    </div>

                                            <!-- Terrain -->
                                            <div class="slds-box slds-m-bottom_medium">
                                                <h4 class="slds-text-heading_small slds-m-bottom_small">Terrain</h4>
                                                <div class="slds-grid slds-wrap slds-gutters">
                                                    <div class="slds-col slds-size_1-of-2 slds-max-small-size_1-of-1">
                                                        <template if:true={property.displayRl0301A}>
                                                            <p><strong>Mesure frontale :</strong> {property.displayRl0301A}</p>
                                                        </template>
                                                        <template if:true={property.displayRl0302A}>
                                                            <p><strong>Superficie du terrain :</strong> {property.displayRl0302A}</p>
                                                        </template>
                                                        <template if:true={property.displayRl0303A}>
                                                            <p><strong>Zonage agricole :</strong> {property.displayRl0303A}</p>
                                                        </template>
                                                        <template if:true={property.displayRl0305A}>
                                                            <p><strong>Superficie en zone agricole :</strong> {property.displayRl0305A}</p>
                                                        </template>
                                                    </div>
                                                </div>
                                            </div>
                                            
                                            <!-- Autres caractéristiques -->
                                            <div class="slds-box slds-m-bottom_medium">
                                                <h4 class="slds-text-heading_small slds-m-bottom_small">Autres caractéristiques</h4>
                                                <div class="slds-grid slds-wrap slds-gutters">
                                                    <div class="slds-col slds-size_1-of-2 slds-max-small-size_1-of-1">
                                                        <template if:true={property.displayRl0309A}>
                                                            <p><strong>Nombre de logements :</strong> {property.displayRl0309A}</p>
                                                        </template>
                                                        <template if:true={property.displayRl0310A}>
                                                            <p><strong>Nombre de pièces :</strong> {property.displayRl0310A}</p>
                                                        </template>
                                                        <template if:true={property.displayRl0311A}>
                                                            <p><strong>Nombre de salles de bain :</strong> {property.displayRl0311A}</p>
                                                        </template>
                                                        <template if:true={property.displayRl0312A}>
                                                            <p><strong>Nombre de foyers :</strong> {property.displayRl0312A}</p>
                                                        </template>
                                                    </div>
                                                </div>
                                                    </div>
                                        </div>
                                    </lightning-accordion-section>
                                    
                                    <!-- SECTION 4 : Valeurs au rôle d'évaluation -->
                                    <lightning-accordion-section name="section4" label="💰 Section 4 : Valeurs au rôle d'évaluation">
                                        <div class="slds-p-around_medium">
                                            <!-- Informations de référence -->
                                            <div class="slds-box slds-m-bottom_medium">
                                                <h4 class="slds-text-heading_small slds-m-bottom_small">Informations de référence</h4>
                                                <template if:true={property.displayRl0401A}>
                                                    <p><strong>Date de référence au marché :</strong> {property.displayRl0401A}</p>
                                                </template>
                                            </div>
                                            
                                            <!-- Valeurs en vigueur -->
                                            <div class="slds-box slds-m-bottom_medium">
                                                <h4 class="slds-text-heading_small slds-m-bottom_small">Valeurs en vigueur</h4>
                                                <div class="slds-grid slds-wrap slds-gutters">
                                                    <div class="slds-col slds-size_1-of-2 slds-max-small-size_1-of-1">
                                                        <template if:true={property.displayRl0402A}>
                                                            <p><strong>Valeur du terrain :</strong> {property.displayRl0402A}</p>
                                                        </template>
                                                        <template if:true={property.displayRl0403A}>
                                                            <p><strong>Valeur du bâtiment :</strong> {property.displayRl0403A}</p>
                                                        </template>
                                                        <template if:true={property.displayRl0411A}>
                                                            <p><strong>Valeur unitaire terrain :</strong> {property.displayRl0411A}</p>
                                                        </template>
                                                        <template if:true={property.displayRl0412A}>
                                                            <p><strong>Valeur unitaire bâtiment :</strong> {property.displayRl0412A}</p>
                                                        </template>
                                                    </div>
                                                    <div class="slds-col slds-size_1-of-2 slds-max-small-size_1-of-1">
                                                        <template if:true={property.displayRl0404A}>
                                                            <p><strong>Valeur totale de l'immeuble :</strong> <span data-field="total-value">{property.displayRl0404A}</span></p>
                                                        </template>
                                                    </div>
                                                </div>
                                            </div>
                                            
                                            <!-- Valeur comparative -->
                                            <div class="slds-box slds-m-bottom_medium">
                                                <h4 class="slds-text-heading_small slds-m-bottom_small">Valeur comparative</h4>
                                                <div class="slds-grid slds-wrap slds-gutters">
                                                    <div class="slds-col slds-size_1-of-2 slds-max-small-size_1-of-1">
                                                        <template if:true={property.displayRl0405A}>
                                                            <p><strong>Valeur au rôle antérieur :</strong> {property.displayRl0405A}</p>
                                                        </template>
                                                        <template if:true={property.displayRl0406A}>
                                                            <p><strong>Code d'exonération :</strong> {property.displayRl0406A}</p>
                                                        </template>
                                                        <template if:true={property.displayRl0407A}>
                                                            <p><strong>Code de classification :</strong> {property.displayRl0407A}</p>
                                                        </template>
                                                    </div>
                                                    <div class="slds-col slds-size_1-of-2 slds-max-small-size_1-of-1">
                                                        <template if:true={property.displayRl0408A}>
                                                            <p><strong>Code de facteur d'ajustement :</strong> {property.displayRl0408A}</p>
                                                        </template>
                                                        <template if:true={property.displayRl0409A}>
                                                            <p><strong>Facteur d'ajustement :</strong> {property.displayRl0409A}</p>
                                                        </template>
                                                        <template if:true={property.displayRl0410A}>
                                                            <p><strong>Code de facteur d'ajustement :</strong> {property.displayRl0410A}</p>
                                                        </template>
                                                    </div>
                                                </div>
                                            </div>
                                            
                                            <!-- Détail des valeurs par usage (RL0504x) -->
                                            <div class="slds-box slds-m-bottom_medium">
                                                <h4 class="slds-text-heading_small slds-m-bottom_small">📋 Détail des valeurs par usage</h4>
                                                <template if:true={property.rl0504Details}>
                                                    <template if:true={property.rl0504Details.length}>
                                                        <lightning-datatable
                                                            data={property.rl0504Details}
                                                            columns={rl0504Columns}
                                                            key-field="id"
                                                            hide-checkbox-column>
                                                        </lightning-datatable>
                                                    </template>
                                                    <template if:false={property.rl0504Details.length}>
                                                        <p class="slds-text-color_weak">Aucun détail de valeur disponible</p>
                                                    </template>
                                                </template>
                                            </div>
                                            
                                        </div>
                                    </lightning-accordion-section>
                                    
                                    <!-- SECTION 5 : Répartition fiscale -->
                                    <lightning-accordion-section name="section5" label="🏛️ Section 5 : Répartition fiscale">
                                        <div class="slds-p-around_medium">
                                            <!-- Catégories de base -->
                                            <div class="slds-box slds-m-bottom_medium">
                                                <h4 class="slds-text-heading_small slds-m-bottom_small">Catégories de base</h4>
                                                <template if:true={property.displayRl0501A}>
                                                    <p><strong>Terrains vagues desservis :</strong> {property.displayRl0501A}</p>
                                                </template>
                                                <template if:true={property.displayRl0502A}>
                                                    <p><strong>Classe immeubles non résidentiels :</strong> {property.displayRl0502A}</p>
                                                </template>
                                                <template if:true={property.displayRl0502A}>
                                                    <p><strong>Pourcentage imposable :</strong> {property.displayRl0502A}</p>
                                                </template>
                                                <template if:true={property.displayRl0502B}>
                                                    <p><strong>Code d'exonération :</strong> {property.displayRl0502B}</p>
                                                </template>
                                                <template if:true={property.displayRl0502C}>
                                                    <p><strong>Date d'exonération :</strong> {property.displayRl0502C}</p>
                                                </template>
                                                <template if:true={property.displayRl0503A}>
                                                    <p><strong>Classe immeubles industriels :</strong> {property.displayRl0503A}</p>
                                                </template>
                                                <template if:true={property.displayRl0503B}>
                                                    <p><strong>Description tarification :</strong> {property.displayRl0503B}</p>
                                                </template>
                                                <template if:true={property.displayRl0503C}>
                                                    <p><strong>Facteur d'ajustement :</strong> {property.displayRl0503C}</p>
                                                </template>
                                            </div>
                                            
                                            <!-- Secteur -->
                                            <div class="slds-box slds-m-bottom_medium">
                                                <h4 class="slds-text-heading_small slds-m-bottom_small">Secteur</h4>
                                                <template if:true={property.displayRl0508A}>
                                                    <p><strong>Code du secteur pour taxation :</strong> {property.displayRl0508A}</p>
                                                </template>
                                                    </div>
                                        </div>
                                    </lightning-accordion-section>
                                    
                                    <!-- SECTION 6 : Déclaration de dépôt du rôle par l'évaluateur -->
                                    <lightning-accordion-section name="section6" label="📝 Section 6 : Déclaration de dépôt du rôle par l'évaluateur">
                                        <div class="slds-p-around_medium">
                                            <!-- Évaluateur responsable -->
                                            <div class="slds-box slds-m-bottom_medium">
                                                <h4 class="slds-text-heading_small slds-m-bottom_small">Évaluateur responsable</h4>
                                                <template if:true={property.displayRl0601A}>
                                                    <p><strong>Nom :</strong> {property.displayRl0601A}</p>
                                                </template>
                                                <template if:true={property.displayRl0601B}>
                                                    <p><strong>Prénom :</strong> {property.displayRl0601B}</p>
                                                </template>
                                                <template if:true={property.displayRl0602A}>
                                                    <p><strong>Titre :</strong> {property.displayRl0602A}</p>
                                                </template>
                                            </div>
                                            
                                            <!-- Organisme et signature -->
                                            <div class="slds-box slds-m-bottom_medium">
                                                <h4 class="slds-text-heading_small slds-m-bottom_small">Organisme et signature</h4>
                                                <template if:true={property.displayRl0603A}>
                                                    <p><strong>Organisme municipal responsable :</strong> {property.displayRl0603A}</p>
                                                </template>
                                                <template if:true={property.displayRl0604A}>
                                                    <p><strong>Date de signature :</strong> {property.displayRl0604A}</p>
                                                </template>
                                                <template if:true={property.displayRl0605A}>
                                                    <p><strong>Lieu de signature :</strong> {property.displayRl0605A}</p>
                                                </template>
                                                    </div>
                                        </div>
                                    </lightning-accordion-section>
                                    
                                    <!-- SECTION 7 : Informations annexables globales -->
                                    <lightning-accordion-section name="section7" label="📊 Section 7 : Informations annexables globales">
                                        <div class="slds-p-around_medium">
                                            <!-- Informations du rôle (global) -->
                                            <div class="slds-box slds-m-bottom_medium">
                                                <h4 class="slds-text-heading_small slds-m-bottom_small">Informations du rôle</h4>
                                                <template if:true={property.displayRlzg0001}>
                                                    <p><strong>Version des informations :</strong> {property.displayRlzg0001}</p>
                                                </template>
                                                <template if:true={property.displayRlzg0002}>
                                                    <p><strong>Date de mise à jour :</strong> {property.displayRlzg0002}</p>
                                                </template>
                                            </div>

                                            <!-- Sections spéciales RLZU (globales) -->
                                            <div class="slds-box slds-m-bottom_medium">
                                                <h4 class="slds-text-heading_small slds-m-bottom_small">Sections spéciales</h4>
                                                <div class="slds-grid slds-wrap slds-gutters">
                                                    <div class="slds-col slds-size_1-of-2">
                                                        <template if:true={property.displayRlzu3001A}>
                                                            <p><strong>Autre superficie :</strong> {property.displayRlzu3001A}</p>
                                                        </template>
                                                        <template if:true={property.displayRlzu3001B}>
                                                            <p><strong>Type superficie :</strong> {property.displayRlzu3001B}</p>
                                                        </template>
                                                        <template if:true={property.displayRlzu3001C}>
                                                            <p><strong>Description superficie :</strong> {property.displayRlzu3001C}</p>
                                                        </template>
                                                    </div>
                                                    <div class="slds-col slds-size_1-of-2">
                                                        <template if:true={property.displayRlzu5001A}>
                                                            <p><strong>Pourcentage copropriété :</strong> {property.displayRlzu5001A}</p>
                                                        </template>
                                                        <template if:true={property.displayRlzu5001B}>
                                                            <p><strong>Type copropriété :</strong> {property.displayRlzu5001B}</p>
                                                        </template>
                                                        <template if:true={property.displayRlzu5001C}>
                                                            <p><strong>Description copropriété :</strong> {property.displayRlzu5001C}</p>
                                                        </template>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </lightning-accordion-section>
                                    
                                    <!-- SECTION 8 : Renseignements annexables de l'unité -->
                                    <lightning-accordion-section name="section8" label="🏢 Section 8 : Renseignements annexables de l'unité">
                                        <div class="slds-p-around_medium">
                                            <!-- Logements (RLZU1007) -->
                                            <div class="slds-box slds-m-bottom_medium">
                                                <h4 class="slds-text-heading_small slds-m-bottom_small">Logements</h4>
                                                <template if:true={property.rlzu1007Details}>
                                                    <template if:true={property.rlzu1007Details.length}>
                                                        <template for:each={property.rlzu1007Details} for:item="logement">
                                                            <div key={logement.numeroLogement} class="slds-grid slds-wrap slds-gutters">
                                                                <div class="slds-col slds-size_1-of-1">
                                                                    <p><strong>Numéro logement :</strong> {logement.numeroLogement}</p>
                                                                </div>
                                                                <div class="slds-col slds-size_1-of-1">
                                                                    <p><strong>Superficie logement :</strong> {logement.superficieLogement}</p>
                                                                </div>
                                                            </div>
                                                        </template>
                                                    </template>
                                                    <template if:false={property.rlzu1007Details.length}>
                                                        <p class="slds-text-color_weak">Aucune information de logement disponible</p>
                                                    </template>
                                                </template>
                                            </div>

                                            <!-- Terrains (RLZU1008) -->
                                            <div class="slds-box slds-m-bottom_medium">
                                                <h4 class="slds-text-heading_small slds-m-bottom_small">Terrains</h4>
                                                <template if:true={property.rlzu1008Details}>
                                                    <template if:true={property.rlzu1008Details.length}>
                                                        <template for:each={property.rlzu1008Details} for:item="terrain">
                                                            <div key={terrain.numero} class="slds-grid slds-wrap slds-gutters">
                                                                <div class="slds-col slds-size_1-of-1">
                                                                    <p><strong>Numéro :</strong> {terrain.numero}</p>
                                                                    <p><strong>Frontage :</strong> {terrain.frontage}</p>
                                                                </div>
                                                                <div class="slds-col slds-size_1-of-1">
                                                                    <p><strong>Superficie :</strong> {terrain.superficie}</p>
                                                                    <p><strong>Forme du terrain :</strong> {terrain.formeTerrain}</p>
                                                                </div>
                                                            </div>
                                                        </template>
                                                    </template>
                                                    <template if:false={property.rlzu1008Details.length}>
                                                        <p class="slds-text-color_weak">Aucune information de terrain disponible</p>
                                                    </template>
                                                </template>
                                            </div>

                                            <!-- Bâtiments (RLZU2001) -->
                                            <div class="slds-box slds-m-bottom_medium">
                                                <h4 class="slds-text-heading_small slds-m-bottom_small">Bâtiments</h4>
                                                <template if:true={property.rlzu2001Details}>
                                                    <template if:true={property.rlzu2001Details.length}>
                                                        <template for:each={property.rlzu2001Details} for:item="batiment">
                                                            <div key={batiment.numeroBatiment} class="slds-grid slds-wrap slds-gutters">
                                                                <div class="slds-col slds-size_1-of-1">
                                                                    <p><strong>Numéro bâtiment :</strong> {batiment.numeroBatiment}</p>
                                                                    <p><strong>Coût de remplacement :</strong> {batiment.coutRemplacement}</p>
                                                                </div>
                                                                <div class="slds-col slds-size_1-of-1">
                                                                    <p><strong>Classe :</strong> {batiment.classe}</p>
                                                                    <p><strong>Type construction :</strong> {batiment.typeConstruction}</p>
                                                                </div>
                                                            </div>
                                                        </template>
                                                    </template>
                                                    <template if:false={property.rlzu2001Details.length}>
                                                        <p class="slds-text-color_weak">Aucune information de bâtiment disponible</p>
                                                    </template>
                                                </template>
                                            </div>

                                            <!-- Usage et construction -->
                                            <div class="slds-box slds-m-bottom_medium">
                                                <h4 class="slds-text-heading_small slds-m-bottom_small">Usage et construction</h4>
                                                <div class="slds-grid slds-wrap slds-gutters">
                                                    <div class="slds-col slds-size_1-of-1 slds-m-bottom_small">
                                                        <template if:true={property.displayRlzu3005A}><p><strong>Usage principal :</strong> {property.displayRlzu3005A}</p></template>
                                                        <template if:true={property.displayRlzu3005B}><p><strong>Sous-usage :</strong> {property.displayRlzu3005B}</p></template>
                                                        <template if:true={property.displayRlzu3005C}><p><strong>Logement accessoire :</strong> {property.displayRlzu3005C}</p></template>
                                                        <template if:true={property.displayRlzu3006B}><p><strong>Revenus :</strong> {property.displayRlzu3006B}</p></template>
                                                        <template if:true={property.displayRlzu3007x}><p><strong>Code de construction :</strong> {property.displayRlzu3007x}</p></template>
                                                    </div>
                                                    <div class="slds-col slds-size_1-of-1">
                                                        <template if:true={property.displayRlzu3101}><p><strong>Date début évaluation :</strong> {property.displayRlzu3101}</p></template>
                                                        <template if:true={property.displayRlzu3102}><p><strong>Date mise en vigueur :</strong> {property.displayRlzu3102}</p></template>
                                                        <template if:true={property.displayRlzu3103}><p><strong>Date fin validité :</strong> {property.displayRlzu3103}</p></template>
                                                        <template if:true={property.displayRlzu3104}><p><strong>Valeur au rôle :</strong> {property.displayRlzu3104}</p></template>
                                                        <template if:true={property.displayRlzu4001}><p><strong>Valeur terrain municipale :</strong> {property.displayRlzu4001}</p></template>
                                                        <template if:true={property.displayRlzu4002}><p><strong>Valeur bâtiment municipale :</strong> {property.displayRlzu4002}</p></template>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </lightning-accordion-section>
                                    
                                </lightning-accordion>
                            </lightning-card>
                        </div>
                    </template>
                </template>
                
                <!-- Bouton Save Assessment -->
                <template if:true={showPropertyDetails}>
                    <div class="slds-m-top_medium slds-text-align_center">
                        <lightning-button 
                            variant="brand" 
                            label="Save Assessment"
                            title="Enregistrer cette évaluation"
                            onclick={handleSaveAssessment}>
                        </lightning-button>
                    </div>
                </template>
                
                <!-- Aucun résultat -->
                <template if:true={showNoResults}>
                    <div class="slds-box slds-theme_warning">
                        <h3 class="slds-text-heading_small">
                            ❌ Aucun résultat
                        </h3>
                        <p>{noResultsMessage}</p>
                    </div>
                </template>
                
            </div>
            
        </div>
    </lightning-card>
</template>
